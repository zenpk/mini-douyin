# mini-douyin
字节跳动青训营抖音项目

## IP、端口设置
服务器 IP：101.43.179.27

服务器端口：10250 (HTTP)

MySQL 端口：3306 (TCP)

注意：抖声 App 内服务器地址需要写全（例如：http://192.168.1.100:10250 ），否则会闪退

## 开发规范

### 语言

注释、commit 信息、README 均使用**中文**

### 命名

| 变量/文件                | 规则（所有均为单数形式）           |
| ------------------------ | ---------------------------------- |
| package                  | 全小写，无下划线                   |
| Go File                  | 全小写，有下划线                   |
| 常量、结构体、函数名     | 大驼峰，缩写全大写，无下划线       |
| 结构体内部变量           | 大驼峰，缩写只大写首字母，无下划线 |
| 结构体外与结构体相关变量 | 小驼峰，缩写只大写首字母，无下划线 |
| 一般变量                 | 小驼峰，缩写全大写，无下划线       |

## 数据库表关系图（ERD）

![ERD](./ERD.jpg)

## 各模块信息
### 1. 注册登录模块

- 密码使用 BCrypt 加密，数据库保存的是加密后的密码
- 每个用户的用户名唯一，作为数据库提取用户信息的判断依据
- 用户 Id（以及视频 Id）的增长方式：~~程序运行时分配两个变量从数据库中分别读取用户和视频的最后一个 Id，新创建时 Id 依次增加~~，GORM 默认下可以使主键自增

### 2. 投稿模块

投稿接口工作方式：先利用 MySQL 主键自增特性获取本次新上传的 videoId，然后和作者的 userId 共同作为文件名的一部分保存在 ./public/videos 中，之后调用 ffmpeg 获取视频的第 300 帧（此处是为了简化处理，更好的实践是先获取视频的总帧数，再取中间某一帧）作为封面，存入 ./public/videos 中

**demo 里 Video 结构体没有 title，需要补充**

#### 存在问题

- [ ] 获取用户投稿列表：点击视频会闪退（客户端问题）

### 3. 视频流模块

**返回前需要查询 favorites 表判断是否点过赞**

#### 存在问题

- [x] GORM 读取视频列表时，没有读取到 Author 信息（尽管外键设置正确），解决方法：使用 Preload 关键词，注意这里传入的字符串应当是 struct 里面的变量名，而不是 SQL 中保存的 column 名
- [ ] 目前查询是否点过赞的方式是一条一条地查询（查 30 遍），不知道是否有更好的办法
- [x] 查询点赞条目的时候，不知道为什么用 RowsAffecrted 不行（解决：必须包含 Find()，否则实际并没有执行查找操作）

### 4. 视频点赞模块

点赞或取消点赞时创建数据库事务，同时完成在 favorites 表中创建新行、在 videos 表中更新点赞数目的操作

#### 存在问题

- [ ] 前端未正确传入 user_id，需手动通过 token 从数据库中查询

### 5. 评论模块

#### 存在问题

- [ ] 前端无删除评论功能，需手动发送 POST 测试删除功能

### 6. 关注取关模块

#### 存在问题

- [ ] 前端未正确传入 user_id，需手动通过 token 从数据库中查询
- [ ] 点击“我的”时不会正确显示关注和粉丝数，但点进其他用户页面则正常显示（经测试，重新登录后则正常显示，而视频流点到作者信息里，需要刷新视频流才能正常显示作者的关注数和粉丝数）